# Chat History Feature Implementation

This document outlines the implementation of the chat history feature in the FableDash AI Agent System, focusing on the parent-child agent relationship and how chat history is managed between them.

## Overview

The chat history feature allows users to:

1. View the chat history of a specific agent
2. View the chat history of child agents for a parent agent
3. View the chat history of the parent agent for a child agent
4. Link chats together in a parent-child relationship

This enables a comprehensive view of all related conversations and facilitates knowledge sharing between agents.

## Database Schema

The feature relies on the following database tables:

### Agents Table

```sql
CREATE TABLE IF NOT EXISTS agents (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    client_id BIGINT REFERENCES clients(id),
    is_parent BOOLEAN DEFAULT FALSE,
    parent_id BIGINT REFERENCES agents(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

Key fields:
- `is_parent`: Indicates if this agent is a parent agent
- `parent_id`: References the parent agent if this is a child agent

### Chats Table

```sql
CREATE TABLE IF NOT EXISTS chats (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    agent_id BIGINT NOT NULL REFERENCES agents(id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    parent_chat_id BIGINT REFERENCES chats(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

Key fields:
- `agent_id`: The agent this chat belongs to
- `parent_chat_id`: References the parent chat if this is a child chat

### Messages Table

```sql
CREATE TABLE IF NOT EXISTS messages (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    chat_id BIGINT NOT NULL REFERENCES chats(id) ON DELETE CASCADE,
    role TEXT NOT NULL CHECK (role IN ('system', 'user', 'assistant')),
    content TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## API Endpoints

### Get Agent Chat History

```
GET /api/chats/agent/{agent_id}/chat-history
```

This endpoint retrieves:
- All chats for the specified agent
- All chats for child agents (if this is a parent agent)
- All chats for the parent agent (if this is a child agent)

### Get Linked Chats

```
GET /api/chats/{chat_id}/linked-chats
```

This endpoint retrieves:
- The specified chat
- The parent chat (if this chat has a parent)
- All child chats (if this chat has children)

## Implementation Details

### Parent-Child Agent Relationship

1. When creating a child agent, the `parent_id` field is set to reference the parent agent
2. The parent agent has `is_parent` set to `true`
3. A parent agent can have multiple child agents, but a child agent can only have one parent

### Parent-Child Chat Relationship

1. When creating a child chat, the `parent_chat_id` field is set to reference the parent chat
2. A parent chat can have multiple child chats, but a child chat can only have one parent

### Chat History Retrieval

The `get_agent_chat_history` endpoint in `app/api/chats.py` handles the retrieval of chat history:

```python
@router.get("/agent/{agent_id}/chat-history", response_model=ChatHistoryResponse)
async def get_agent_chat_history(agent_id: int = Path(..., description="The ID of the agent")):
    """
    Get full chat history for an agent including child agent chats.
    """
    try:
        # Check if agent exists
        agent_result = supabase.table("agents").select("*").eq("id", agent_id).single().execute()
        
        if hasattr(agent_result, 'error') and agent_result.error:
            logger.error(f"Agent not found: {agent_result.error}")
            raise HTTPException(status_code=404, detail=f"Agent not found: {agent_result.error}")
        
        agent = agent_result.data
        
        # Get all chats for this agent
        agent_chats_result = supabase.table("chats").select("*").eq("agent_id", agent_id).order("created_at", desc=True).execute()
        
        if hasattr(agent_chats_result, 'error') and agent_chats_result.error:
            logger.error(f"Error fetching agent chats: {agent_chats_result.error}")
            raise HTTPException(status_code=500, detail=f"Error fetching agent chats: {agent_chats_result.error}")
        
        agent_chats = agent_chats_result.data or []
        
        # If this is a parent agent, get all child agents
        child_agent_chats = []
        if agent.get("is_parent"):
            # Get all child agents
            child_agents_result = supabase.table("agents").select("id").eq("parent_id", agent_id).execute()
            
            if not hasattr(child_agents_result, 'error') and child_agents_result.data:
                # Get chats for all child agents
                child_agent_ids = [a["id"] for a in child_agents_result.data]
                
                child_chats_result = supabase.table("chats").select("*").in_("agent_id", child_agent_ids).order("created_at", desc=True).execute()
                
                if not hasattr(child_chats_result, 'error') and child_chats_result.data:
                    child_agent_chats = child_chats_result.data
        
        # If this is a child agent, get the parent agent's chats
        parent_agent_chats = []
        if agent.get("parent_id"):
            parent_chats_result = supabase.table("chats").select("*").eq("agent_id", agent["parent_id"]).order("created_at", desc=True).execute()
            
            if not hasattr(parent_chats_result, 'error') and parent_chats_result.data:
                parent_agent_chats = parent_chats_result.data
        
        return {
            "success": True,
            "agent": agent,
            "agentChats": agent_chats,
            "childAgentChats": child_agent_chats,
            "parentAgentChats": parent_agent_chats
        }
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"Error fetching agent chat history: {e}")
        raise HTTPException(status_code=500, detail=str(e))
```

## Frontend Integration

The frontend can display the chat history in a hierarchical view:

1. Agent's own chats
2. Child agent chats (if this is a parent agent)
3. Parent agent chats (if this is a child agent)

This allows users to navigate between related chats and see the full context of conversations.

## Use Cases

### Knowledge Sharing

Parent agents can access the chat history of their child agents, allowing them to:
- Learn from child agent interactions
- Provide context for their own responses
- Ensure consistency across child agents

### Specialized Agents

Child agents can be specialized for specific tasks while still having access to the parent agent's knowledge:
- Parent agent handles general queries
- Child agents handle specialized domains
- All agents share a common knowledge base

### Hierarchical Organization

Organizations can structure their agents in a hierarchical manner:
- Top-level parent agents for company-wide knowledge
- Mid-level parent agents for department-specific knowledge
- Child agents for individual roles or tasks

## Future Enhancements

1. **Multi-level Hierarchies**: Support for grandparent-parent-child relationships
2. **Cross-agent Chat References**: Allow chats to reference chats from other agents
3. **Chat Merging**: Ability to merge related chats into a single conversation
4. **Chat Forking**: Create new child chats from specific points in a parent chat
5. **Selective Sharing**: Control which chats are shared between parent and child agents
